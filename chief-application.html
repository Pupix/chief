<link rel="import" href="chief-container.html">

<script>
    window.Chief = window.Chief || {};

    /**
     * A class mixin used to create a Chief Application.
     *
     * @function Chief.Application
     *
     * @param {Class} superclass - An instance of an HTMLElement
     * @returns {Class}
     */
    window.Chief.Application = superclass => class extends Chief.Container(superclass) {

        static get properties() {
            return {
                /**
                 * The registry of commands at the application's disposal.
                 *
                 * @property commands
                 */
                commands: {
                    type: Object,
                    value: {}
                },

                /**
                 * If set, the application will enable `debug` mode
                 *
                 * @property debug
                 */
                debug: {
                    type: Boolean,
                    value: false
                }
            };
        }

        static get observers() {
            return [
                '__stateChanged(state.*)'
            ]
        }

        /** PUBLIC *********************************************************************************/

        /**
         * Adds a new command to the manager's `registry`.
         *
         * You may need this if your app implements code splitting
         * and you want to load some of the commands dynamically.
         *
         * @param {string} name The name of the command to be added.
         * @param {Function} execute The function to be called when the command is invoked.
         */
        addCommand(name, execute) {
            if (typeof name !== 'string') {
                throw new Error('Expected name to be a string.');
            }

            if (typeof execute !== 'function') {
                throw new Error('Expected execute to be a function.');
            }

            this.set(`commands.${name}`, execute);
        }

        /**
         * Removes a new command from the manager's `registry`.
         *
         * @param {string} name The name of the command to be removed.
         */
        removeCommand(name) {
            if (typeof name !== 'string') {
                throw new Error('Expected name to be a string.');
            }

            this.set(`commands.${name}`, null);
        }

        /** PRIVATE *********************************************************************************/

        /**
         * Executes the passed command
         *
         * @param {Function} command - The command to be executed
         * @param {...Any} [payload] - The arguments to be passed to the command
         * @private
         */
        __executeCommand(command, ...payload) {
            command.bind(this, this.get('state'), ...payload)();
        }

        /**
         * Notifies container elements about state changes
         *
         * @param {Object} change - A Polymer change record
         * @private
         */
        __notifyContainerElements(change) {
            this.get('application.containerElements').forEach(element => {
                element.notifyPath(change.path, change.value);
            });
        }

        /** LIFECYCLE *******************************************************************************/

        ready() {
            super.ready();

            this.addEventListener('CHIEF:INVOKE_COMMAND', this.__handleInvokeCommand.bind(this));
            this.set('application.element', this);
        }

        /** OBSERVERS *******************************************************************************/

        /**
         * `state` property observer
         *
         * @param {Object} change - The change record
         */
        __stateChanged(change) {
            this.__notifyContainerElements(change);
        }

        /** HANDLERS *******************************************************************************/

        /**
         * Validates and executes commands invoked by Chief.Invoker elements
         *
         * @param {Event} event - The event generated by Chief.Invoker elements
         * @private
         */
        __handleInvokeCommand(event) {
            const { name, payload } = event.detail;

            if (typeof name !== 'string') {
                throw new Error('Expected command to be a string.');
            }

            const command = this.get(`commands.${name}`);

            if (!command) {
                console.warn(`Command '${name}' doesn't exist.`);
                return;
            }

            if (this.debug) {
                console.info(`[${event.composedPath()[0].localName}::${name}]:`, [...payload]);
            }

            this.__executeCommand(command, ...payload);
        }
    };
</script>
